---
description: GenExpr (gen~ codebox) syntax — use when editing .codebox or GenExpr in gen~
globs: **/*.codebox,**/*.genexpr
alwaysApply: false
---

# GenExpr syntax guide

GenExpr is the **text language for gen~ codebox** (and expr) in Max. It is **not** JavaScript or C; it only resembles them. Use this when editing `modal_bar_gen.codebox` or any GenExpr in gen~.

**When you fix a GenExpr syntax error** in a `.codebox` or `.genexpr` file: add the **exact error message** and the **correct pattern** to the **Common errors and fixes** section below so the rule stays up to date.

**Ref:** [GenExpr (Cycling '74)](https://docs.cycling74.com/userguide/gen/gen_genexpr)  
**Full reference:** [docs/GENEXPR_REFERENCE.md](docs/GENEXPR_REFERENCE.md)

---

## Common errors and fixes

*(Update this section whenever a new GenExpr syntax error is encountered and fixed.)*

| Error message (or description) | Cause | Fix |
|--------------------------------|--------|-----|
| `declaration missing arguments or semicolon` | Use of `var` (or other declaration keyword), or wrong **Param** syntax | Remove `var`; assign directly. For **Param** use `Param name(default_value);` e.g. `Param frequency(440.);` — not `Param name value;` or `Param name, value;`. |
| `function definitions not allowed here` / `function definitions must precede all statements` | A statement (e.g. assignment) appears before a function definition | Move all function definitions to the top of the file; put every other statement after the last function. |
| (Parser confusion on a line with commas) | Multiple declarations on one line: `a = 1, b = 2;` | Split into one assignment per line. Exception: multi-return `a, b = func();` is valid. |
| `use of undeclared identifier 'history'` | GenExpr **codebox** has no `history(x)` function | Use the **History** declaration instead: `History var1, var2, ...;` at top of main code. Reading `var1` gives previous sample; assigning to `var1` stores for next. Replace every `history(x)` with `x` and ensure `x` is in the History list. |
| `variable X is not defined` | A variable is used in `history(X)` on the same line where it is assigned (e.g. `x, y = f(history(x))`) | Use **History** declaration (see above); then use the variable name directly instead of `history(x)`. |
| `failed to compile genpatcher` (dsp.gen / main2.lua) | Usually a **cascade from a codebox error** (e.g. undefined variable) | Fix the codebox error first (e.g. "variable X is not defined"); recompile. |

---

## Variables and assignment

- **No declaration keyword.** Do not use `var`, `let`, or `const`. Variables are created by assignment and are local to scope.
- **One declaration per line.** Do not put multiple assignments on one line with commas (e.g. `a = 1, b = 2;`). Use separate lines:
  - **Wrong:** `a1 = x, a2 = y, b0 = z;`
  - **Right:** `a1 = x;` then `a2 = y;` then `b0 = z;`
- **Multiple return values** from a single call are the exception: `out1, out2 = someFunc();` is one assignment and is valid.

---

## Functions

- **No `function` keyword.** Define with name and parentheses only:
  - **Wrong:** `function myFunc(a, b) { ... }`
  - **Right:** `myFunc(a, b) { ... }`
- **Functions must precede all statements.** Put every function definition at the top of the codebox, then all other code (assignments, `out1 = ...`, etc.). Any statement (including a simple assignment like `inv_sr = 1./48000.;`) before a function definition will trigger: *"function definitions must precede all statements"*.

---

## Statements and semicolons

- **Semicolons** are required between multiple statements. Single-statement codeboxes can omit the final semicolon.
- **Comments:** `//` single-line and `/* */` multi-line (C-style).

---

## Inlets and outlets

- **Inlets:** `in1`, `in2`, … `inN` (or `in` for `in1`).
- **Outlets:** `out1`, `out2`, … `outN` (or `out` for `out1`).
- The codebox infers the number of inlets/outlets from the highest `inN` / `outN` used.

---

## Control flow

- **Branching:** `if (cond) { ... }`, `else if (cond) { ... }`, `else { ... }`.
- **Loops:** `for (i=0; i<10; i+=1) { ... }`, `while (cond) { ... }`. No `++`; use `i+=1`. `break` and `continue` are supported.
- **Ternary:** `cond ? valueIfTrue : valueIfFalse`.

---

## Other

- **No array notation** — GenExpr has no `[index]` or array type.
- **Param:** `Param parameter_name(default_value);` (capital P; default value in parentheses). Set from Max with `setparam parameter_name value`.
- **Built-ins** (examples): `noise()`, `cos()`, `sin()`, `exp()`, `abs()`, etc. — Gen operators. **One-sample delay:** use `History var1, var2, ...;` (capital H); reading `var` gives previous sample; assign to `var` to store for next. There is no `history(x)` function in GenExpr codebox.
- **Return:** Use `return expr;` or `return a, b;` for multiple return values.

---

*(See **Common errors and fixes** above; add new rows when new syntax errors are fixed.)*
